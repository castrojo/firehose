---
// SearchBar component with Pagefind integration
// Provides instant search (<300ms) with term highlighting
---

<div class="search-container">
  <div class="search-wrapper">
    <input
      type="search"
      id="search-input"
      class="search-input"
      placeholder="Search releases..."
      aria-label="Search releases"
      autocomplete="off"
    />
    <button
      type="button"
      id="search-clear"
      class="search-clear"
      aria-label="Clear search"
      style="display: none;"
    >
      âœ•
    </button>
  </div>
  
  <div id="search-results" class="search-results" style="display: none;">
    <div class="search-results-header">
      <span id="search-count"></span>
    </div>
    <div id="search-results-list" class="search-results-list"></div>
  </div>
</div>

<script>
  // Pagefind search implementation
  (async function() {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const searchClear = document.getElementById('search-clear') as HTMLButtonElement;
    const searchResults = document.getElementById('search-results') as HTMLElement;
    const searchResultsList = document.getElementById('search-results-list') as HTMLElement;
    const searchCount = document.getElementById('search-count') as HTMLElement;
    
    if (!searchInput || !searchClear || !searchResults || !searchResultsList || !searchCount) {
      console.error('[SearchBar] Required elements not found');
      return;
    }
    
    // Load Pagefind
    let pagefind: any = null;
    try {
      // @ts-ignore - Pagefind is loaded dynamically
      pagefind = await import('/pagefind/pagefind.js');
      await pagefind.options({
        excerptLength: 15,
      });
      console.log('[SearchBar] Pagefind loaded successfully');
    } catch (error) {
      console.error('[SearchBar] Failed to load Pagefind:', error);
      return;
    }
    
    let debounceTimer: number | null = null;
    const DEBOUNCE_MS = 300;
    const MIN_CHARS = 2;
    const MAX_RESULTS = 50;
    
    // Perform search
    async function performSearch(query: string) {
      if (!pagefind) return;
      
      if (query.length < MIN_CHARS) {
        searchResults.style.display = 'none';
        return;
      }
      
      try {
        const startTime = performance.now();
        const results = await pagefind.search(query);
        const endTime = performance.now();
        const duration = Math.round(endTime - startTime);
        
        console.log(`[SearchBar] Search completed in ${duration}ms, found ${results.results.length} results`);
        
        if (results.results.length === 0) {
          showNoResults();
          return;
        }
        
        // Limit results for performance
        const limitedResults = results.results.slice(0, MAX_RESULTS);
        
        // Load result data
        const resultData = await Promise.all(
          limitedResults.map((r: any) => r.data())
        );
        
        displayResults(resultData, results.results.length);
      } catch (error) {
        console.error('[SearchBar] Search error:', error);
        showError();
      }
    }
    
    // Display search results
    function displayResults(results: any[], totalCount: number) {
      searchResultsList.innerHTML = results.map(result => {
        const projectName = result.meta?.project || 'Unknown Project';
        const projectStatus = result.meta?.status || '';
        
        const statusBadge = projectStatus
          ? `<span class="project-status ${projectStatus}">${projectStatus}</span>`
          : '';
        
        return `
          <article class="search-result">
            <div class="result-header">
              <span class="project-name">${escapeHtml(projectName)}</span>
              ${statusBadge}
            </div>
            <h3 class="result-title">
              <a href="${escapeHtml(result.url)}" target="_blank" rel="noopener noreferrer">
                ${escapeHtml(result.meta?.title || result.url)}
              </a>
            </h3>
            <div class="result-excerpt">${result.excerpt}</div>
          </article>
        `;
      }).join('');
      
      const displayCount = results.length;
      const countText = totalCount > MAX_RESULTS
        ? `Showing ${displayCount} of ${totalCount} results`
        : `${totalCount} result${totalCount === 1 ? '' : 's'}`;
      
      searchCount.textContent = countText;
      searchResults.style.display = 'block';
    }
    
    // Show no results message
    function showNoResults() {
      searchResultsList.innerHTML = `
        <div class="no-results">
          <p>No results found</p>
          <p class="no-results-hint">Try different keywords or check spelling</p>
        </div>
      `;
      searchCount.textContent = '0 results';
      searchResults.style.display = 'block';
    }
    
    // Show error message
    function showError() {
      searchResultsList.innerHTML = `
        <div class="no-results">
          <p>Search error occurred</p>
          <p class="no-results-hint">Please try again</p>
        </div>
      `;
      searchCount.textContent = '';
      searchResults.style.display = 'block';
    }
    
    // HTML escape utility
    function escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Clear search
    function clearSearch() {
      searchInput.value = '';
      searchResults.style.display = 'none';
      searchClear.style.display = 'none';
      searchInput.focus();
    }
    
    // Event handlers
    searchInput.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.trim();
      
      // Show/hide clear button
      searchClear.style.display = query ? 'block' : 'none';
      
      // Clear existing timer
      if (debounceTimer) {
        window.clearTimeout(debounceTimer);
      }
      
      // Debounce search
      if (query.length >= MIN_CHARS) {
        debounceTimer = window.setTimeout(() => {
          performSearch(query);
        }, DEBOUNCE_MS);
      } else {
        searchResults.style.display = 'none';
      }
    });
    
    searchClear.addEventListener('click', clearSearch);
    
    // Keyboard shortcuts
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        clearSearch();
      }
    });
    
    // Focus search on '/' key
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== searchInput) {
        e.preventDefault();
        searchInput.focus();
      }
    });
  })();
</script>

<style>
  .search-container {
    margin-bottom: 2rem;
    position: relative;
  }
  
  .search-wrapper {
    position: relative;
    width: 100%;
  }
  
  .search-input {
    width: 100%;
    padding: 0.75rem 2.5rem 0.75rem 1rem;
    font-size: 1rem;
    border: 1px solid var(--color-border-default, #d0d7de);
    border-radius: 6px;
    background: var(--color-bg-default, #ffffff);
    color: var(--color-text-primary, #24292f);
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  
  .search-input:focus {
    outline: none;
    border-color: var(--color-accent-emphasis, #0969da);
    box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
  }
  
  .search-input::placeholder {
    color: var(--color-text-tertiary, #6e7781);
  }
  
  .search-clear {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: var(--color-text-secondary, #57606a);
    font-size: 1.25rem;
    width: 2rem;
    height: 2rem;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }
  
  .search-clear:hover {
    background: var(--color-bg-secondary, #f6f8fa);
  }
  
  .search-results {
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 0;
    right: 0;
    width: 100%;
    background: var(--color-bg-default, #ffffff);
    border: 1px solid var(--color-border-default, #d0d7de);
    border-radius: 6px;
    box-shadow: 0 8px 24px rgba(140, 149, 159, 0.2);
    max-height: 600px;
    overflow: hidden;
    z-index: 1000;
  }
  
  .search-results-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--color-border-default, #d0d7de);
    font-size: 0.875rem;
    color: var(--color-text-secondary, #57606a);
    font-weight: 600;
  }
  
  .search-results-list {
    max-height: 540px;
    overflow-y: auto;
  }
  
  .search-result {
    padding: 1rem;
    border-bottom: 1px solid var(--color-border-default, #d0d7de);
    transition: background 0.2s;
    cursor: pointer;
  }
  
  .search-result:last-child {
    border-bottom: none;
  }
  
  .search-result:hover {
    background: var(--color-bg-secondary, #f6f8fa);
  }
  
  .result-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  .project-name {
    font-weight: 600;
    color: var(--color-text-primary, #24292f);
    font-size: 0.875rem;
  }
  
  .project-status {
    display: inline-block;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }
  
  .graduated {
    background: #dafbe1;
    color: #1a7f37;
  }
  
  .incubating {
    background: #fff8c5;
    color: #9a6700;
  }
  
  .sandbox {
    background: #ddf4ff;
    color: #0969da;
  }
  
  .result-title {
    font-size: 0.9375rem;
    margin: 0.25rem 0;
    line-height: 1.4;
  }
  
  .result-title a {
    color: var(--color-text-primary, #24292f);
    text-decoration: none;
    font-weight: 500;
  }
  
  .result-title a:hover {
    color: var(--color-text-link, #0969da);
    text-decoration: underline;
  }
  
  .result-excerpt {
    font-size: 0.875rem;
    color: var(--color-text-secondary, #57606a);
    line-height: 1.5;
  }
  
  /* Highlight matched terms in excerpts (Pagefind adds <mark> tags) */
  .result-excerpt :global(mark) {
    background: #fff8c5;
    color: #24292f;
    font-weight: 600;
    padding: 0.125rem 0.25rem;
    border-radius: 2px;
  }
  
  .no-results {
    padding: 2rem;
    text-align: center;
    color: var(--color-text-secondary, #57606a);
  }
  
  .no-results p:first-child {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  
  .no-results-hint {
    font-size: 0.875rem;
    color: var(--color-text-tertiary, #6e7781);
  }
  
  /* Mobile responsive */
  @media (max-width: 768px) {
    .search-wrapper {
      max-width: 100%;
    }
    
    .search-results {
      max-width: 100%;
      max-height: 400px;
    }
    
    .search-results-list {
      max-height: 340px;
    }
    
    .search-input {
      font-size: 0.9375rem;
    }
  }
  
  @media (max-width: 480px) {
    .search-input {
      padding: 0.625rem 2rem 0.625rem 0.75rem;
      font-size: 0.875rem;
    }
    
    .search-result {
      padding: 0.75rem;
    }
    
    .result-title {
      font-size: 0.875rem;
    }
    
    .result-excerpt {
      font-size: 0.8125rem;
    }
  }
</style>
