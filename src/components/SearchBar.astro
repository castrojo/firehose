---
// SearchBar component for project name search
// Shows matching projects, clicking a project applies the filter
---

<div class="search-container">
  <div class="search-wrapper">
    <input
      type="search"
      id="search-input"
      class="search-input"
      placeholder="Search projects..."
      aria-label="Search projects"
      autocomplete="off"
    />
    <button
      type="button"
      id="search-clear"
      class="search-clear"
      aria-label="Clear search"
      style="display: none;"
    >
      âœ•
    </button>
  </div>
  
  <div id="search-results" class="search-results" style="display: none;">
    <div class="search-results-header">
      <span id="search-count"></span>
    </div>
    <div id="search-results-list" class="search-results-list"></div>
  </div>
</div>

<script>
  // Project name search - shows matching projects, click to filter
  (function() {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const searchClear = document.getElementById('search-clear') as HTMLButtonElement;
    const searchResults = document.getElementById('search-results') as HTMLElement;
    const searchResultsList = document.getElementById('search-results-list') as HTMLElement;
    const searchCount = document.getElementById('search-count') as HTMLElement;
    const projectFilterSelect = document.getElementById('filter-project') as HTMLSelectElement;
    
    if (!searchInput || !searchClear || !searchResults || !searchResultsList || !searchCount) {
      console.error('[SearchBar] Required elements not found');
      return;
    }
    
    console.log('[SearchBar] Project search initialized');
    
    let debounceTimer: number | null = null;
    const DEBOUNCE_MS = 300;
    const MIN_CHARS = 1;
    
    // Get unique project names from all releases
    function getUniqueProjects(): Map<string, { count: number, status: string }> {
      const projects = new Map<string, { count: number, status: string }>();
      const allCards = document.querySelectorAll('.release-card[data-project]');
      
      allCards.forEach(card => {
        const projectName = (card as HTMLElement).dataset.project || '';
        const projectStatus = (card as HTMLElement).dataset.status || '';
        
        if (projectName) {
          if (!projects.has(projectName)) {
            projects.set(projectName, { count: 0, status: projectStatus });
          }
          projects.get(projectName)!.count++;
        }
      });
      
      return projects;
    }
    
    // Get releases for a specific project
    function getProjectReleases(projectName: string): Array<{ title: string, url: string }> {
      const releases: Array<{ title: string, url: string }> = [];
      const cards = document.querySelectorAll(`.release-card[data-project="${CSS.escape(projectName)}"]`);
      
      // Limit to 5 most recent releases
      const limit = Math.min(5, cards.length);
      
      for (let i = 0; i < limit; i++) {
        const card = cards[i] as HTMLElement;
        const titleElement = card.querySelector('.release-title a');
        
        if (titleElement) {
          const title = titleElement.textContent?.trim() || '';
          const url = titleElement.getAttribute('href') || '';
          
          if (title && url) {
            releases.push({ title, url });
          }
        }
      }
      
      return releases;
    }
    
    // Perform project name search
    function performSearch(query: string) {
      if (query.length < MIN_CHARS) {
        searchResults.style.display = 'none';
        return;
      }
      
      const queryLower = query.toLowerCase();
      const allProjects = getUniqueProjects();
      
      // Filter projects by name (case-insensitive partial match)
      const matchingProjects = Array.from(allProjects.entries())
        .filter(([projectName]) => projectName.toLowerCase().includes(queryLower))
        .sort(([a], [b]) => a.localeCompare(b));
      
      console.log(`[SearchBar] Found ${matchingProjects.length} projects matching "${query}"`);
      
      if (matchingProjects.length === 0) {
        showNoResults(query);
        return;
      }
      
      displayResults(matchingProjects, query);
    }
    
    // Display search results - projects with their releases
    function displayResults(projects: Array<[string, { count: number, status: string }]>, query: string) {
      searchResultsList.innerHTML = projects.map(([projectName]) => {
        const releases = getProjectReleases(projectName);
        
        // Build project header (clickable to filter)
        let html = `
          <div class="search-result-group">
            <div class="search-result project-header" data-project-name="${escapeHtml(projectName)}">
              <span class="project-name">${escapeHtml(projectName)}</span>
            </div>
        `;
        
        // Add release links under the project
        if (releases.length > 0) {
          html += `<div class="release-list">`;
          releases.forEach(release => {
            html += `
              <div class="release-item" data-release-url="${escapeHtml(release.url)}">
                <span class="release-link">${escapeHtml(projectName)} ${escapeHtml(release.title)}</span>
              </div>
            `;
          });
          html += `</div>`;
        }
        
        html += `</div>`;
        return html;
      }).join('');
      
      searchCount.textContent = `${projects.length} project${projects.length === 1 ? '' : 's'}`;
      searchResults.style.display = 'block';
      
      // Attach click handlers to results
      attachResultClickHandlers();
    }
    
    // Attach click handlers to search results
    function attachResultClickHandlers() {
      // Project headers - click to filter
      const projectHeaders = document.querySelectorAll('.search-result.project-header[data-project-name]');
      
      projectHeaders.forEach(result => {
        result.addEventListener('click', () => {
          const projectName = (result as HTMLElement).dataset.projectName || '';
          
          if (projectName && projectFilterSelect) {
            // Set the project filter
            projectFilterSelect.value = projectName;
            
            // Trigger the filter change event
            projectFilterSelect.dispatchEvent(new Event('change'));
            
            // Clear and hide search
            clearSearch();
            
            console.log(`[SearchBar] Applied filter for project: ${projectName}`);
          }
        });
      });
      
      // Release items - click to open release URL
      const releaseItems = document.querySelectorAll('.release-item[data-release-url]');
      
      releaseItems.forEach(item => {
        item.addEventListener('click', () => {
          const releaseUrl = (item as HTMLElement).dataset.releaseUrl || '';
          
          if (releaseUrl) {
            window.open(releaseUrl, '_blank', 'noopener,noreferrer');
            console.log(`[SearchBar] Opened release: ${releaseUrl}`);
          }
        });
      });
    }
    
    // Show no results message
    function showNoResults(query: string) {
      searchResultsList.innerHTML = `
        <div class="no-results">
          <p>No projects found matching "${escapeHtml(query)}"</p>
          <p class="no-results-hint">Try a different project name</p>
        </div>
      `;
      searchCount.textContent = '0 projects';
      searchResults.style.display = 'block';
    }
    
    // HTML escape utility
    function escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Clear search
    function clearSearch() {
      searchInput.value = '';
      searchResults.style.display = 'none';
      searchClear.style.display = 'none';
    }
    
    // Event handlers
    searchInput.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.trim();
      
      // Show/hide clear button
      searchClear.style.display = query ? 'block' : 'none';
      
      // Clear existing timer
      if (debounceTimer) {
        window.clearTimeout(debounceTimer);
      }
      
      // Debounce search
      if (query.length >= MIN_CHARS) {
        debounceTimer = window.setTimeout(() => {
          performSearch(query);
        }, DEBOUNCE_MS);
      } else {
        searchResults.style.display = 'none';
      }
    });
    
    searchClear.addEventListener('click', clearSearch);
    
    // Keyboard shortcuts
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        clearSearch();
      }
    });
    
    // Focus search on '/' key (but not when already typing)
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== searchInput && 
          !(document.activeElement instanceof HTMLInputElement) &&
          !(document.activeElement instanceof HTMLTextAreaElement)) {
        e.preventDefault();
        searchInput.focus();
      }
    });
    
    // Close search results when clicking outside
    document.addEventListener('click', (e) => {
      if (!searchResults.contains(e.target as Node) && 
          !searchInput.contains(e.target as Node) &&
          !searchClear.contains(e.target as Node)) {
        if (searchResults.style.display === 'block') {
          searchResults.style.display = 'none';
        }
      }
    });
  })();
</script>

<style>
  .search-container {
    margin-bottom: 2rem;
    position: relative;
  }
  
  .search-wrapper {
    position: relative;
    width: 100%;
  }
  
  .search-input {
    width: 100%;
    padding: 0.75rem 2.5rem 0.75rem 1rem;
    font-size: 1rem;
    border: 1px solid var(--color-border-default, #d0d7de);
    border-radius: 6px;
    background: var(--color-bg-default, #ffffff);
    color: var(--color-text-primary, #24292f);
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  
  .search-input:focus {
    outline: none;
    border-color: var(--color-accent-emphasis, #0969da);
    box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
  }
  
  .search-input::placeholder {
    color: var(--color-text-tertiary, #6e7781);
  }
  
  .search-clear {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: var(--color-text-secondary, #57606a);
    font-size: 1.25rem;
    width: 2rem;
    height: 2rem;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }
  
  .search-clear:hover {
    background: var(--color-bg-secondary, #f6f8fa);
  }
  
  .search-results {
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 0;
    right: 0;
    width: 100%;
    background: var(--color-bg-default, #ffffff);
    border: 1px solid var(--color-border-default, #d0d7de);
    border-radius: 6px;
    box-shadow: 0 8px 24px rgba(140, 149, 159, 0.2);
    max-height: 600px;
    overflow: hidden;
    z-index: 1000;
  }
  
  .search-results-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--color-border-default, #d0d7de);
    font-size: 0.875rem;
    color: var(--color-text-secondary, #57606a);
    font-weight: 600;
  }
  
  .search-results-list {
    max-height: 540px;
    overflow-y: auto;
  }
  
  .search-result-group {
    border-bottom: 1px solid var(--color-border-default, #d0d7de);
  }
  
  .search-result-group:last-child {
    border-bottom: none;
  }
  
  .search-result {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .search-result.project-header {
    background: var(--color-bg-secondary, #f6f8fa);
    font-weight: 600;
    border-bottom: 1px solid var(--color-border-default, #d0d7de);
  }
  
  .search-result.project-header:hover {
    background: #eaeef2;
  }
  
  .release-list {
    background: var(--color-bg-default, #ffffff);
  }
  
  .release-item {
    padding: 0.625rem 1rem 0.625rem 2rem;
    cursor: pointer;
    transition: background 0.2s;
    border-bottom: 1px solid #f6f8fa;
  }
  
  .release-item:last-child {
    border-bottom: none;
  }
  
  .release-item:hover {
    background: var(--color-bg-secondary, #f6f8fa);
  }
  
  .release-link {
    font-size: 0.875rem;
    color: var(--color-text-secondary, #57606a);
  }
  
  .release-item:hover .release-link {
    color: var(--color-text-link, #D62293);
  }
  
  .project-name {
    font-weight: 500;
    color: var(--color-text-primary, #24292f);
    font-size: 0.9375rem;
  }
  
  .project-header:hover .project-name {
    color: var(--color-text-link, #D62293);
  }
  
  .project-status {
    display: inline-block;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }
  
  .graduated {
    background: #dafbe1;
    color: #1a7f37;
  }
  
  .incubating {
    background: #fff8c5;
    color: #9a6700;
  }
  
  .sandbox {
    background: #ddf4ff;
    color: #0969da;
  }
  
  .no-results {
    padding: 2rem;
    text-align: center;
    color: var(--color-text-secondary, #57606a);
  }
  
  .no-results p:first-child {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  
  .no-results-hint {
    font-size: 0.875rem;
    color: var(--color-text-tertiary, #6e7781);
  }
  
  /* Mobile responsive */
  @media (max-width: 768px) {
    .search-wrapper {
      max-width: 100%;
    }
    
    .search-results {
      max-width: 100%;
      max-height: 400px;
    }
    
    .search-results-list {
      max-height: 340px;
    }
    
    .search-input {
      font-size: 0.9375rem;
    }
  }
  
  @media (max-width: 480px) {
    .search-input {
      padding: 0.625rem 2rem 0.625rem 0.75rem;
      font-size: 0.875rem;
    }
    
    .search-result {
      padding: 0.75rem;
    }
    
    .result-title {
      font-size: 0.875rem;
    }
    
    .result-excerpt {
      font-size: 0.8125rem;
    }
  }
</style>
