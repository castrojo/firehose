---
phase: 04-search-and-filtering
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scripts/keyboard-nav.ts
  - src/components/KeyboardHelp.astro
  - src/pages/index.astro
  - src/components/ReleaseCard.astro
autonomous: true

must_haves:
  truths:
    - "User presses j/k to navigate down/up between releases (vim-style)"
    - "User presses Enter or o to open focused release in new tab"
    - "User presses / to focus search input"
    - "User presses ? to see keyboard shortcuts help modal"
    - "Keyboard shortcuts don't trigger when typing in input fields"
  artifacts:
    - path: "src/scripts/keyboard-nav.ts"
      provides: "KeyboardNavigator class with vim-style navigation"
      min_lines: 100
      exports: ["KeyboardNavigator"]
    - path: "src/components/KeyboardHelp.astro"
      provides: "Help modal showing keyboard shortcuts"
      min_lines: 50
    - path: "src/pages/index.astro"
      provides: "KeyboardHelp integration and script import"
      contains: "KeyboardHelp"
  key_links:
    - from: "src/scripts/keyboard-nav.ts"
      to: ".release-card elements"
      via: "querySelectorAll and focus management"
      pattern: "querySelectorAll.*release-card"
    - from: "KeyboardNavigator"
      to: "window keydown events"
      via: "addEventListener"
      pattern: "addEventListener.*keydown"
    - from: "src/pages/index.astro"
      to: "keyboard-nav.ts"
      via: "script import"
      pattern: "keyboard-nav"
---

<objective>
Implement vim-style keyboard shortcuts (j/k navigation, o/Enter to open, / for search, ? for help) that work seamlessly without interfering with normal typing in input fields.

Purpose: Provide power users with efficient keyboard-driven navigation, reducing reliance on mouse/trackpad and enabling rapid browsing of releases. Keyboard shortcuts are a quality-of-life feature for frequent users.

Output: Working keyboard navigation system with visual focus indicators, help modal, and proper input context detection.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/keyboard-shortcuts.md
@src/pages/index.astro
@src/components/ReleaseCard.astro
</context>

<tasks>

<task type="auto">
  <name>Create KeyboardNavigator class with vim-style shortcuts</name>
  <files>src/scripts/keyboard-nav.ts</files>
  <action>
Create a TypeScript module that implements keyboard navigation with vim-style shortcuts:

**Module structure:**

```typescript
// src/scripts/keyboard-nav.ts

export class KeyboardNavigator {
  private focusedIndex = -1;
  private items: HTMLElement[] = [];
  private searchInput: HTMLInputElement | null = null;
  
  constructor(itemSelector: string, searchInputSelector: string) {
    this.items = Array.from(document.querySelectorAll(itemSelector));
    this.searchInput = document.querySelector(searchInputSelector);
    this.attachListeners();
    console.log(`[KeyboardNav] Initialized with ${this.items.length} items`);
  }
  
  private attachListeners(): void {
    document.addEventListener('keydown', (e: KeyboardEvent) => {
      // Don't intercept when user is typing in inputs
      if (this.isTypingContext(e.target)) return;
      
      switch(e.key) {
        case 'j': // Next release
          e.preventDefault();
          this.moveDown();
          break;
        case 'k': // Previous release
          e.preventDefault();
          this.moveUp();
          break;
        case '/': // Focus search
          e.preventDefault();
          this.focusSearch();
          break;
        case 'o': // Open in new tab
        case 'Enter':
          e.preventDefault();
          this.openFocused();
          break;
        case '?': // Help modal
          e.preventDefault();
          this.showHelp();
          break;
        case 'Escape': // Close help or blur search
          this.handleEscape();
          break;
      }
    });
  }
  
  private isTypingContext(target: EventTarget | null): boolean {
    if (!target || !(target instanceof HTMLElement)) return false;
    const tagName = target.tagName.toLowerCase();
    
    // Check for input elements
    if (tagName === 'input' || tagName === 'textarea') return true;
    
    // Check for contentEditable
    if (target.isContentEditable) return true;
    
    // Check if inside Pagefind search UI (future-proof for search component)
    if (target.closest('.pagefind-ui') || target.closest('.search-bar')) return true;
    
    return false;
  }
  
  private moveDown(): void {
    if (this.items.length === 0) return;
    
    this.focusedIndex = Math.min(this.focusedIndex + 1, this.items.length - 1);
    this.scrollToFocused();
    this.announceNavigation();
  }
  
  private moveUp(): void {
    if (this.items.length === 0) return;
    
    this.focusedIndex = Math.max(this.focusedIndex - 1, 0);
    this.scrollToFocused();
    this.announceNavigation();
  }
  
  private scrollToFocused(): void {
    const item = this.items[this.focusedIndex];
    if (!item) return;
    
    // Remove previous focus styling
    this.items.forEach(el => el.classList.remove('kbd-focused'));
    
    // Add focus styling to current item
    item.classList.add('kbd-focused');
    
    // Scroll into view smoothly (only if not visible)
    item.scrollIntoView({ 
      behavior: 'smooth', 
      block: 'nearest',
      inline: 'nearest'
    });
  }
  
  private openFocused(): void {
    const item = this.items[this.focusedIndex];
    if (!item) return;
    
    const link = item.querySelector('a[href]') as HTMLAnchorElement;
    if (link) {
      window.open(link.href, '_blank', 'noopener,noreferrer');
    }
  }
  
  private focusSearch(): void {
    if (this.searchInput) {
      this.searchInput.focus();
      this.searchInput.select(); // Select existing text
    }
  }
  
  private showHelp(): void {
    const modal = document.getElementById('keyboard-help-modal');
    const backdrop = document.getElementById('keyboard-help-backdrop');
    modal?.classList.add('visible');
    backdrop?.classList.add('visible');
  }
  
  private hideHelp(): void {
    const modal = document.getElementById('keyboard-help-modal');
    const backdrop = document.getElementById('keyboard-help-backdrop');
    modal?.classList.remove('visible');
    backdrop?.classList.remove('visible');
  }
  
  private handleEscape(): void {
    // If help modal is open, close it
    const helpModal = document.getElementById('keyboard-help-modal');
    if (helpModal?.classList.contains('visible')) {
      this.hideHelp();
      return;
    }
    
    // If search is focused, blur it
    if (document.activeElement === this.searchInput) {
      this.searchInput?.blur();
      return;
    }
    
    // Otherwise, clear keyboard focus
    this.items.forEach(el => el.classList.remove('kbd-focused'));
    this.focusedIndex = -1;
  }
  
  private announceNavigation(): void {
    const item = this.items[this.focusedIndex];
    const liveRegion = document.getElementById('kbd-live-region');
    if (liveRegion && item) {
      const title = item.querySelector('h2, .release-title')?.textContent?.trim() || 'Release';
      liveRegion.textContent = `Focused: ${title}`;
    }
  }
  
  // Public method to refresh items (for infinite scroll)
  public refresh(): void {
    this.items = Array.from(document.querySelectorAll('.release-card'));
    console.log(`[KeyboardNav] Refreshed, now tracking ${this.items.length} items`);
  }
}

// Auto-initialize on page load
if (typeof window !== 'undefined') {
  let navigator: KeyboardNavigator | null = null;
  
  document.addEventListener('DOMContentLoaded', () => {
    navigator = new KeyboardNavigator('.release-card', '#search-input, .search-bar input');
    
    // Refresh on infinite scroll load (listen for custom event or observe DOM)
    const observer = new MutationObserver(() => {
      navigator?.refresh();
    });
    
    const releaseList = document.getElementById('release-list');
    if (releaseList) {
      observer.observe(releaseList, { childList: true });
    }
  });
}
```

**Key implementation details:**

1. **Context detection:** Checks if user is typing before intercepting keys
2. **Smooth scrolling:** Uses `scrollIntoView` with `block: 'nearest'` to avoid jarring jumps
3. **Focus management:** Adds/removes `.kbd-focused` class for visual indicator
4. **Screen reader support:** Updates live region with focused item title
5. **Escape handling:** Context-aware (close modal â†’ blur search â†’ clear focus)
6. **Infinite scroll support:** Refresh method updates item list when new releases load

**Avoid:**
- Global keyboard shortcuts that break form inputs
- Scrolling when item is already visible (use `block: 'nearest'`)
- Not preventing default behavior (would trigger browser shortcuts)
</action>
  <verify>
1. Build and preview the site
2. Press 'j' multiple times - focus moves down through releases
3. Press 'k' - focus moves up
4. Verify blue outline appears on focused release
5. Press 'o' or Enter - focused release opens in new tab
6. Press '/' - search input gains focus
7. Type in search input and press 'j' - should NOT navigate (typing context)
8. Press '?' - help modal appears (will be created in next task)
9. Press Escape - help modal closes
10. Check console for "[KeyboardNav] Initialized" message
</verify>
  <done>
KeyboardNavigator class implemented with j/k navigation, o/Enter to open, / for search focus, ? for help, and proper input context detection. Class is auto-initialized on page load and refreshes when infinite scroll adds items.
</done>
</task>

<task type="auto">
  <name>Create KeyboardHelp modal component</name>
  <files>src/components/KeyboardHelp.astro</files>
  <action>
Create KeyboardHelp.astro component that displays a modal with all keyboard shortcuts:

**Component structure:**

```astro
---
// src/components/KeyboardHelp.astro
// No props needed - static content
---

<!-- Backdrop -->
<div id="keyboard-help-backdrop" class="keyboard-help-backdrop"></div>

<!-- Modal -->
<div id="keyboard-help-modal" class="keyboard-help-modal" role="dialog" aria-labelledby="help-title" aria-modal="true">
  <div class="help-header">
    <h2 id="help-title">Keyboard Shortcuts</h2>
    <button id="close-help" aria-label="Close help" class="close-button">
      <span aria-hidden="true">Ã—</span>
    </button>
  </div>
  
  <div class="help-content">
    <table class="shortcuts-table">
      <tbody>
        <tr>
          <td class="shortcut-key"><kbd>j</kbd></td>
          <td class="shortcut-description">Next release</td>
        </tr>
        <tr>
          <td class="shortcut-key"><kbd>k</kbd></td>
          <td class="shortcut-description">Previous release</td>
        </tr>
        <tr>
          <td class="shortcut-key"><kbd>o</kbd> or <kbd>Enter</kbd></td>
          <td class="shortcut-description">Open focused release in new tab</td>
        </tr>
        <tr>
          <td class="shortcut-key"><kbd>/</kbd></td>
          <td class="shortcut-description">Focus search input</td>
        </tr>
        <tr>
          <td class="shortcut-key"><kbd>?</kbd></td>
          <td class="shortcut-description">Show this help</td>
        </tr>
        <tr>
          <td class="shortcut-key"><kbd>Esc</kbd></td>
          <td class="shortcut-description">Close help / Blur search / Clear focus</td>
        </tr>
      </tbody>
    </table>
    
    <p class="help-note">
      <strong>Tip:</strong> Keyboard shortcuts work when you're not typing in an input field.
    </p>
  </div>
</div>

<script>
  // Close button handler
  document.getElementById('close-help')?.addEventListener('click', () => {
    document.getElementById('keyboard-help-modal')?.classList.remove('visible');
    document.getElementById('keyboard-help-backdrop')?.classList.remove('visible');
  });
  
  // Close on backdrop click
  document.getElementById('keyboard-help-backdrop')?.addEventListener('click', () => {
    document.getElementById('keyboard-help-modal')?.classList.remove('visible');
    document.getElementById('keyboard-help-backdrop')?.classList.remove('visible');
  });
</script>

<style>
  .keyboard-help-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    backdrop-filter: blur(2px);
  }
  
  .keyboard-help-backdrop.visible {
    display: block;
  }
  
  .keyboard-help-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--color-bg-default, #ffffff);
    border: 1px solid var(--color-border-default, #d0d7de);
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow: auto;
  }
  
  .keyboard-help-modal.visible {
    display: block;
    animation: modalSlideIn 0.2s ease-out;
  }
  
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translate(-50%, -48%);
    }
    to {
      opacity: 1;
      transform: translate(-50%, -50%);
    }
  }
  
  .help-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--color-border-default, #d0d7de);
  }
  
  .help-header h2 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text-primary, #24292f);
  }
  
  .close-button {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--color-text-secondary, #57606a);
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: background 0.15s ease;
  }
  
  .close-button:hover {
    background: var(--color-bg-secondary, #f6f8fa);
    color: var(--color-text-primary, #24292f);
  }
  
  .help-content {
    padding: 1.5rem;
  }
  
  .shortcuts-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .shortcuts-table tr {
    border-bottom: 1px solid var(--color-border-default, #d0d7de);
  }
  
  .shortcuts-table tr:last-child {
    border-bottom: none;
  }
  
  .shortcuts-table td {
    padding: 0.75rem 0;
  }
  
  .shortcut-key {
    width: 40%;
    font-weight: 500;
  }
  
  .shortcuts-table kbd {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    font-family: ui-monospace, 'Cascadia Code', monospace;
    background: var(--color-bg-secondary, #f6f8fa);
    border: 1px solid var(--color-border-default, #d0d7de);
    border-radius: 4px;
    box-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
    margin: 0 0.25rem;
  }
  
  .shortcut-description {
    color: var(--color-text-secondary, #57606a);
  }
  
  .help-note {
    margin-top: 1.5rem;
    padding: 0.75rem;
    background: var(--color-bg-secondary, #f6f8fa);
    border-radius: 6px;
    font-size: 0.875rem;
    color: var(--color-text-secondary, #57606a);
    line-height: 1.5;
  }
  
  .help-note strong {
    color: var(--color-text-primary, #24292f);
  }
  
  /* Mobile responsive */
  @media (max-width: 480px) {
    .keyboard-help-modal {
      width: 95%;
      max-height: 90vh;
    }
    
    .help-header,
    .help-content {
      padding: 1rem;
    }
    
    .shortcuts-table kbd {
      font-size: 0.75rem;
      padding: 0.2rem 0.4rem;
    }
  }
</style>
```

**Key features:**

1. **Modal dialog:** Centered, with backdrop blur
2. **Close mechanisms:** X button, backdrop click, Escape key (handled by KeyboardNavigator)
3. **Keyboard shortcuts table:** Clear layout with kbd elements styled like keys
4. **Accessibility:** role="dialog", aria-labelledby, aria-modal
5. **Animation:** Smooth slide-in on open
6. **Responsive:** Mobile-friendly sizing

**Avoid:**
- Complex modal libraries (vanilla is sufficient)
- Missing close mechanisms (users need multiple ways to dismiss)
</action>
  <verify>
1. Press '?' - help modal appears
2. Verify modal is centered and readable
3. Verify kbd elements look like keyboard keys
4. Click X button - modal closes
5. Press '?' again, click backdrop - modal closes
6. Press '?' again, press Escape - modal closes
7. Verify animation is smooth (no janky transitions)
8. Test on mobile (modal should be 95% width, readable)
9. Verify all 6 shortcuts are listed correctly
</verify>
  <done>
KeyboardHelp modal component created with shortcuts table, close mechanisms, and responsive styling. Modal displays on '?' keypress and can be closed via X button, backdrop click, or Escape key.
</done>
</task>

<task type="auto">
  <name>Integrate keyboard navigation into index.astro and add visual focus styles</name>
  <files>src/pages/index.astro, src/components/ReleaseCard.astro</files>
  <action>
Integrate keyboard navigation into index.astro by importing the script and KeyboardHelp component, and add visual focus indicator styles:

**1. Update index.astro:**

Import KeyboardHelp component:
```astro
import KeyboardHelp from '../components/KeyboardHelp.astro';
```

Add KeyboardHelp modal before closing </body>:
```astro
  <footer class="site-footer">
    ...
  </footer>
  
  <!-- Keyboard help modal -->
  <KeyboardHelp />
  
  <!-- Screen reader live region for keyboard navigation -->
  <div id="kbd-live-region" aria-live="polite" aria-atomic="true" class="sr-only"></div>
</body>
```

Import keyboard navigation script in <head>:
```astro
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="CNCF project releases aggregated in one place">
  <title>The Firehose - CNCF Releases</title>
  <script src="/src/scripts/keyboard-nav.ts" type="module"></script>
</head>
```

**2. Add CSS for keyboard focus indicator and screen reader utility:**

In index.astro's `<style>` section:
```css
/* Keyboard navigation focus indicator */
.release-card {
  transition: box-shadow 0.2s ease, border-color 0.2s ease;
}

.release-card.kbd-focused {
  box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.3);
  border-color: #0969da;
  outline: none;
  position: relative;
}

.release-card.kbd-focused::before {
  content: '';
  position: absolute;
  top: -3px;
  left: -3px;
  right: -3px;
  bottom: -3px;
  border-radius: 8px;
  border: 2px solid #0969da;
  pointer-events: none;
}

/* Screen reader only utility */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

/* Help button in header (visual hint) */
.keyboard-help-button {
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-border-default);
  border-radius: 6px;
  padding: 0.5rem;
  cursor: pointer;
  color: var(--color-text-secondary);
  font-size: 1rem;
  width: 32px;
  height: 32px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s ease;
  margin-left: 1rem;
}

.keyboard-help-button:hover {
  background: var(--color-bg-default);
  color: var(--color-text-primary);
  border-color: var(--color-text-primary);
}
```

**3. Add help button to header (optional but recommended for discoverability):**

In the site header, add a button to trigger help modal:
```astro
<header class="site-header">
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1 class="site-title">ðŸ”¥ The Firehose</h1>
        <p class="site-subtitle">CNCF Project Releases</p>
      </div>
      <button 
        id="help-button" 
        class="keyboard-help-button"
        aria-label="Keyboard shortcuts"
        title="Keyboard shortcuts (Press ?)"
      >
        ?
      </button>
    </div>
  </div>
</header>

<script>
  document.getElementById('help-button')?.addEventListener('click', () => {
    document.getElementById('keyboard-help-modal')?.classList.add('visible');
    document.getElementById('keyboard-help-backdrop')?.classList.add('visible');
  });
</script>
```

**Why these changes:**

- Script in <head> ensures early initialization
- Visual focus indicator uses high-contrast blue (WCAG compliant)
- Screen reader live region announces navigation
- Help button provides visual hint for keyboard shortcuts
- Help button placement doesn't interfere with main content

**Avoid:**
- Low-contrast focus indicators (accessibility issue)
- Loading script in <body> (delays initialization)
- Missing screen reader announcements
</action>
  <verify>
1. Build and preview the site
2. Press 'j' several times - verify blue outline appears on focused release
3. Verify outline is clearly visible against both white and gray backgrounds
4. Press 'k' - verify focus moves up correctly
5. Verify screen reader live region updates (check with DevTools)
6. Click '?' button in header - help modal appears
7. Verify no console errors about missing modules
8. Test with screen reader (optional but recommended)
9. Verify transitions are smooth (no layout shifts)
10. Test on mobile - verify help button is touch-friendly
</verify>
  <done>
Keyboard navigation is fully integrated into index.astro with script import, KeyboardHelp modal, visual focus indicators, screen reader support, and header help button. Navigation works smoothly with clear visual feedback. Help is discoverable via both keyboard (?) and mouse (button).
</done>
</task>

</tasks>

<verification>
**End-to-end keyboard navigation verification:**

1. Press 'j' five times - focus moves down through releases with visible outline
2. Press 'k' three times - focus moves back up
3. Press 'o' on focused release - opens in new tab
4. Press 'Enter' on focused release - also opens in new tab
5. Press '/' - search input gains focus, can type immediately
6. Type in search box and press 'j' - does NOT navigate (typing context working)
7. Press Escape - search input loses focus
8. Press '?' - help modal appears with all shortcuts listed
9. Press Escape - help modal closes
10. Click '?' button in header - help modal appears
11. Click backdrop - help modal closes
12. Scroll down to infinite scroll area, press 'j' - navigation works with new items
13. No console errors

**Requirements coverage:**
- âœ… KBD-01: j/k navigation (vim-style)
- âœ… KBD-02: Enter/o to open release
- âœ… KBD-03: / to focus search
- âœ… KBD-04: ? for keyboard shortcuts help
- âœ… KBD-05: Don't trigger in input fields

**Accessibility verification:**
- Visual focus indicator is WCAG compliant (3:1 contrast ratio)
- Screen reader announces navigation
- Help modal is accessible (role="dialog", aria-labelledby)
- Keyboard shortcuts don't break Tab navigation
</verification>

<success_criteria>
1. User can press j/k to navigate down/up between releases
2. Focused release has clear visual indicator (blue outline)
3. User can press Enter or o to open focused release in new tab
4. User can press / to focus search input and immediately type
5. Typing in search input does NOT trigger keyboard shortcuts
6. User can press ? to see keyboard shortcuts help modal
7. Help modal displays all 6 shortcuts clearly
8. Help modal can be closed with X button, backdrop click, or Escape
9. Navigation works with both SSR releases and infinite scroll items
10. Screen reader announces focused release title
11. Help button in header is visible and clickable
12. No JavaScript errors in console
</success_criteria>

<output>
After completion, create `.planning/phases/04-search-and-filtering/04-03-SUMMARY.md` documenting:
- Keyboard navigation implementation
- Context detection logic
- Accessibility features
- Performance considerations
- Any deviations from plan
- Evidence of success criteria
</output>
