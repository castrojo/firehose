---
phase: 04-search-and-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/pages/index.astro
  - src/components/SearchBar.astro
autonomous: true

must_haves:
  truths:
    - "User types in search box and sees matching releases instantly (<300ms)"
    - "Search results highlight matching terms"
    - "Search works offline after initial page load"
  artifacts:
    - path: "package.json"
      provides: "pagefind dev dependency"
      contains: "pagefind"
    - path: "src/components/SearchBar.astro"
      provides: "Search input with Pagefind integration"
      min_lines: 80
    - path: "src/pages/index.astro"
      provides: "SearchBar component integration and data-pagefind attributes"
      contains: "SearchBar"
  key_links:
    - from: "src/components/SearchBar.astro"
      to: "/pagefind/pagefind.js"
      via: "dynamic import in client script"
      pattern: "import.*pagefind\\.js"
    - from: "src/pages/index.astro"
      to: "SearchBar"
      via: "component import and usage"
      pattern: "<SearchBar"
    - from: "ReleaseCard articles"
      to: "Pagefind index"
      via: "data-pagefind-body attribute"
      pattern: "data-pagefind-body"
---

<objective>
Implement Pagefind-powered search that allows users to find specific releases by typing keywords, with instant results (<300ms), term highlighting, and offline functionality.

Purpose: Enable discovery of specific releases among 600+ entries without manual scrolling. Search is the primary discovery mechanism for finding releases by content, project name, or keywords.

Output: Working search bar with Pagefind integration, indexed release content, and real-time search results with highlighting.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/filtering-search.md
@.planning/phases/03-user-interface/03-01-SUMMARY.md
@src/pages/index.astro
@src/components/ReleaseCard.astro
@src/components/InfiniteScroll.astro
</context>

<tasks>

<task type="auto">
  <name>Install Pagefind and configure build pipeline</name>
  <files>package.json</files>
  <action>
Install Pagefind as a dev dependency and update the build script to run Pagefind indexing after Astro build:

1. Install Pagefind: `npm install -D pagefind`

2. Update package.json "build" script to: `"build": "astro check && astro build && pagefind --site dist"`

3. Verify Pagefind CLI is available: `npx pagefind --help`

**Why this approach:**
- Pagefind runs AFTER Astro build (requires HTML output)
- `--site dist` tells Pagefind to index the dist/ directory
- Pagefind creates `/pagefind/` directory in dist/ with search index
- Zero runtime dependencies (index is static)

**Avoid:** Running Pagefind before Astro build (will fail - no HTML to index)
</action>
  <verify>
Run `npm run build` and confirm:
- Build completes successfully
- dist/pagefind/ directory exists
- dist/pagefind/pagefind.js file exists
- dist/pagefind/pagefind-ui.js file exists
- Build time increases by ~5-10 seconds (indexing time)
</verify>
  <done>
Build pipeline successfully runs Astro build followed by Pagefind indexing, creating searchable index in dist/pagefind/. No errors in build output.
</done>
</task>

<task type="auto">
  <name>Create SearchBar component with Pagefind integration</name>
  <files>src/components/SearchBar.astro</files>
  <action>
Create a new SearchBar.astro component that provides a search input and integrates with Pagefind's JS API for custom search UI:

**Component structure:**
1. Search input with placeholder "Search releases..."
2. Results container that displays search results
3. Clear button to reset search
4. Result count display
5. Client-side script that loads Pagefind and handles search

**Implementation details:**
- Use Pagefind JS API (not default UI) for custom styling
- Load Pagefind dynamically: `await import('/pagefind/pagefind.js')`
- Debounce search input (300ms) to avoid excessive API calls
- Display results with: title, project name, status badge, excerpt with highlighting
- Show "No results" message when search returns empty
- Show "Type to search..." when input is empty
- Limit results to 50 (performance)
- Each result links to original release (preserve link behavior)

**Search behavior:**
- Trigger search on input (not submit button - instant search)
- Minimum 2 characters before searching
- Clear button resets input and hides results
- Pressing Escape clears search

**Result HTML structure:**
```html
<article class="search-result">
  <div class="result-header">
    <span class="project-name">{projectName}</span>
    <span class="project-status {status}">{status}</span>
  </div>
  <h3 class="result-title">
    <a href="{link}" target="_blank">{title}</a>
  </h3>
  <div class="result-excerpt" set:html={excerpt}></div>
</article>
```

**Styling:**
- Match GitHub Primer design (consistent with ReleaseCard)
- Search input: full width on mobile, max 600px on desktop
- Results dropdown: absolute positioned, max-height 600px, overflow auto
- Result items: hover state, pointer cursor
- Highlight matched terms in bold or background color

**Avoid:**
- Using default PagefindUI (we need custom styling)
- Searching on every keystroke (use debounce)
- Rendering full markdown in results (use excerpts only)
</action>
  <verify>
1. Build the project: `npm run build`
2. Start preview server: `cd dist && python3 -m http.server 8080`
3. Open http://localhost:8080
4. Type "kubernetes" in search box
5. Confirm:
   - Results appear within 300ms
   - Matching terms are highlighted
   - Results show project name, status, title, excerpt
   - Clicking result opens GitHub release in new tab
   - Clear button resets search
   - "No results" appears for nonsense query like "zzzxxx"
</verify>
  <done>
SearchBar component renders search input, fetches Pagefind results dynamically, displays formatted results with highlighting, and provides clear/reset functionality. Search responds in <300ms. Results are clickable and open releases in new tabs.
</done>
</task>

<task type="auto">
  <name>Add Pagefind indexing attributes to ReleaseCard and integrate SearchBar</name>
  <files>src/pages/index.astro, src/components/ReleaseCard.astro</files>
  <action>
Update ReleaseCard and index.astro to enable Pagefind indexing and integrate the SearchBar component:

**1. Update ReleaseCard.astro:**

Add `data-pagefind-body` attribute to the article element to mark it for indexing:
```astro
<article class="release-card" data-pagefind-body>
```

Add hidden metadata for Pagefind filters (used by future filtering):
```astro
<div 
  data-pagefind-meta="project:{data.projectName || data.feedTitle}"
  data-pagefind-meta="status:{data.projectStatus}"
  data-pagefind-meta="date:{data.isoDate}"
  hidden
></div>
```

**2. Update index.astro:**

Import SearchBar at top:
```astro
import SearchBar from '../components/SearchBar.astro';
```

Add SearchBar before the stats bar (in the header area):
```astro
<main class="container">
  <!-- Search bar -->
  <SearchBar />
  
  <!-- Stats bar -->
  <div class="stats">
    ...
  </div>
</main>
```

**3. Update InfiniteScroll.astro renderReleaseCard() function:**

Add `data-pagefind-ignore` to dynamically rendered cards (they're already in the index from SSR):
```typescript
return `
  <article class="release-card" data-pagefind-ignore>
```

**Why this approach:**
- `data-pagefind-body` marks content for indexing
- Hidden metadata allows future filtering by project/status/date
- SearchBar placement before stats keeps it prominent
- `data-pagefind-ignore` prevents duplicate indexing of infinite scroll items

**Avoid:**
- Indexing duplicate content (infinite scroll items are already indexed from SSR batch)
- Missing metadata that enables filtering
</action>
  <verify>
1. Run `npm run build` and check build output for Pagefind indexing stats
2. Confirm Pagefind reports indexing ~610 pages (or number of releases)
3. Start preview: `cd dist && python3 -m http.server 8080`
4. Search for project name (e.g., "Dapr")
5. Search for common term (e.g., "release")
6. Search for code term (e.g., "docker")
7. Verify all searches return relevant results
8. Verify highlighted excerpts show matching terms
9. Confirm no console errors about Pagefind
</verify>
  <done>
ReleaseCard components are indexed by Pagefind with metadata. SearchBar is integrated into index.astro and displays search results. Search functionality is working end-to-end with <300ms response time and term highlighting.
</done>
</task>

</tasks>

<verification>
**End-to-end search verification:**

1. Build and preview the site
2. Type "kubernetes" - Results appear instantly (<300ms)
3. Type "release notes" - Multiple results with highlighting
4. Type "zzzxxx" - "No results found" message
5. Clear search - Results disappear
6. Search works without network (offline after initial load)
7. No JavaScript errors in console
8. Search input is keyboard accessible (Tab, Escape, Enter)

**Requirements coverage:**
- ✅ SRCH-01: Full-text search across titles and content
- ✅ SRCH-02: Instant results (<300ms)
- ✅ SRCH-03: Term highlighting in results
- ✅ SRCH-04: Offline search (static index)

**Performance targets:**
- Search response: <300ms
- Index size: <100KB per 100 releases (~600KB for 610 releases)
- Build time increase: 5-10 seconds (one-time indexing)
</verification>

<success_criteria>
1. User can type search query and see results within 300ms
2. Search results highlight matching terms in excerpts
3. Search works offline after initial page load (no network requests)
4. Pagefind index is generated during build (dist/pagefind/ exists)
5. Search results link to actual GitHub releases
6. Clear button resets search and hides results
7. Build completes successfully with Pagefind indexing
</success_criteria>

<output>
After completion, create `.planning/phases/04-search-and-filtering/04-01-SUMMARY.md` documenting:
- Pagefind integration approach
- Search performance metrics
- Component structure and API usage
- Any deviations from plan
- Evidence of success criteria
</output>
