---
phase: 03-user-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/pages/index.astro
  - src/components/ReleaseCard.astro
  - src/lib/markdown.ts
autonomous: true

must_haves:
  truths:
    - "Release notes render with proper markdown (headers, lists, code blocks, links)"
    - "Code blocks have syntax highlighting"
    - "Markdown renders exactly as it appears on GitHub"
  artifacts:
    - path: "src/lib/markdown.ts"
      provides: "GitHub-compatible markdown rendering"
      exports: ["renderMarkdown"]
      min_lines: 30
    - path: "src/components/ReleaseCard.astro"
      provides: "Release display with rendered markdown"
      min_lines: 50
    - path: "package.json"
      provides: "marked dependency"
      contains: "marked"
  key_links:
    - from: "src/components/ReleaseCard.astro"
      to: "src/lib/markdown.ts"
      via: "import renderMarkdown"
      pattern: "import.*renderMarkdown.*from.*markdown"
    - from: "src/components/ReleaseCard.astro"
      to: "release.data.content"
      via: "renders markdown from content field"
      pattern: "renderMarkdown.*content"
---

<objective>
Transform plain text release notes into properly formatted GitHub-style markdown with code blocks, headers, lists, links, and tables rendered exactly as they appear on GitHub.

Purpose: Release notes are written in markdown and lose all formatting when displayed as plain text. Proper markdown rendering is essential for readability (code examples, installation instructions, breaking changes are unreadable without formatting).

Output: Working markdown renderer integrated into release display, with syntax highlighting for code blocks.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STACK.md
@.planning/codebase/CONVENTIONS.md
@.planning/phase-2-verification.md

# Current implementation
@src/pages/index.astro
@src/lib/schemas.ts
@src/lib/feed-loader.ts
</context>

<tasks>

<task type="auto">
  <name>Install marked library for markdown rendering</name>
  <files>package.json</files>
  <action>
Install marked library for GitHub-compatible markdown rendering:

```bash
npm install marked
npm install --save-dev @types/marked
```

Why marked:
- GitHub-compatible rendering (what users expect)
- Battle-tested (50M+ weekly downloads)
- Lightweight (~35KB minified)
- Supports GFM (GitHub Flavored Markdown): tables, strikethrough, autolinks
- Simple API - no complex plugins needed

Do NOT use:
- remark/rehype: Too complex, heavier bundle, overkill for our needs
- markdown-it: Good but marked is more GitHub-compatible
- Astro's built-in markdown: Designed for .md files, not runtime rendering of feed content
  </action>
  <verify>
```bash
npm list marked
npm list @types/marked
```

Both should be installed and show version numbers.
  </verify>
  <done>
- marked appears in package.json dependencies
- @types/marked appears in package.json devDependencies
- No npm installation errors
  </done>
</task>

<task type="auto">
  <name>Create markdown rendering utility with GitHub-compatible settings</name>
  <files>src/lib/markdown.ts</files>
  <action>
Create `src/lib/markdown.ts` with GitHub Flavored Markdown (GFM) support:

```typescript
import { marked } from 'marked';
import { gfmHeadingId } from 'marked-gfm-heading-id';
import { markedHighlight } from 'marked-highlight';

// Configure marked for GitHub-style rendering
marked.use(gfmHeadingId());
marked.use({
  gfm: true,              // GitHub Flavored Markdown
  breaks: true,           // Convert \n to <br> (GitHub behavior)
  pedantic: false,
  mangle: false,          // Don't mangle email addresses
  headerIds: true,        // Add IDs to headers
});

// Add syntax highlighting with marked-highlight
// Use simple class-based highlighting (actual syntax coloring via CSS)
marked.use(markedHighlight({
  langPrefix: 'language-',
  highlight(code, lang) {
    // Return code wrapped in spans for CSS styling
    // Don't use heavy runtime syntax highlighter - add CSS classes only
    return code;
  }
}));

/**
 * Render markdown content to HTML using GitHub-compatible rules
 * @param markdown - Raw markdown string from feed content
 * @returns Sanitized HTML string safe for insertion via set:html
 */
export function renderMarkdown(markdown: string | undefined): string {
  if (!markdown) return '';
  
  try {
    // Parse markdown to HTML
    const html = marked.parse(markdown);
    
    // marked.parse returns string or Promise<string>
    // In synchronous mode it returns string
    return typeof html === 'string' ? html : '';
  } catch (error) {
    console.error('Markdown rendering error:', error);
    // Fallback to escaped plain text on error
    return markdown;
  }
}

/**
 * Truncate markdown content to a preview length
 * Strips markdown syntax and returns plain text
 */
export function getMarkdownPreview(markdown: string | undefined, maxLength: number = 300): string {
  if (!markdown) return '';
  
  // Strip markdown syntax for preview
  const plain = markdown
    .replace(/#{1,6}\s/g, '')           // Remove headers
    .replace(/\*\*(.+?)\*\*/g, '$1')    // Remove bold
    .replace(/\*(.+?)\*/g, '$1')        // Remove italic
    .replace(/\[(.+?)\]\(.+?\)/g, '$1') // Remove links, keep text
    .replace(/`(.+?)`/g, '$1')          // Remove inline code
    .replace(/```[\s\S]*?```/g, '')     // Remove code blocks
    .trim();
  
  return plain.length > maxLength
    ? plain.substring(0, maxLength) + '...'
    : plain;
}
```

Install additional marked plugins:
```bash
npm install marked-gfm-heading-id marked-highlight
```

Why these settings:
- gfm: true - Tables, strikethrough, autolinks (GitHub features)
- breaks: true - GitHub converts \n to <br> (not just \n\n)
- headerIds: true - Enables anchor links to headers
- No heavy syntax highlighter - Use CSS classes for code styling (lightweight)
  </action>
  <verify>
```bash
# TypeScript compilation check
npx tsc --noEmit

# Verify exports
grep -q "export function renderMarkdown" src/lib/markdown.ts && echo "âœ… renderMarkdown exported"
grep -q "export function getMarkdownPreview" src/lib/markdown.ts && echo "âœ… getMarkdownPreview exported"
```
  </verify>
  <done>
- src/lib/markdown.ts exists with renderMarkdown() and getMarkdownPreview()
- marked configured with GFM and GitHub-compatible settings
- TypeScript compiles without errors
- Functions exported and importable
  </done>
</task>

<task type="auto">
  <name>Create ReleaseCard component with markdown rendering</name>
  <files>src/components/ReleaseCard.astro</files>
  <action>
Create `src/components/ReleaseCard.astro` to display a single release with rendered markdown:

```astro
---
import type { FeedEntry } from '../lib/schemas';
import { renderMarkdown } from '../lib/markdown';

interface Props {
  release: {
    id: string;
    data: FeedEntry;
  };
}

const { release } = Astro.props;
const { data } = release;

// Render markdown content
const htmlContent = renderMarkdown(data.content || data.contentSnippet);

// Format date
const formattedDate = data.isoDate
  ? new Date(data.isoDate).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  : null;
---

<article class="release-card">
  <div class="release-header">
    <span class="project-name">{data.projectName || data.feedTitle || 'Unknown Project'}</span>
    {data.projectStatus && (
      <span class={`project-status ${data.projectStatus}`}>
        {data.projectStatus}
      </span>
    )}
  </div>
  
  {data.projectDescription && (
    <p class="project-description">{data.projectDescription}</p>
  )}
  
  <h2 class="release-title">
    <a href={data.link} target="_blank" rel="noopener noreferrer">
      {data.title}
    </a>
  </h2>
  
  {formattedDate && (
    <div class="release-date">
      <time datetime={data.isoDate}>{formattedDate}</time>
    </div>
  )}
  
  <!-- Rendered markdown content -->
  <div class="release-content markdown-body" set:html={htmlContent} />
</article>

<style>
  .release-card {
    border: 1px solid var(--color-border-default, #d0d7de);
    border-radius: 6px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    background: var(--color-bg-default, #ffffff);
  }
  
  .release-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  .project-name {
    font-weight: 600;
    color: var(--color-text-primary, #0969da);
    font-size: 0.875rem;
  }
  
  .project-status {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }
  
  .graduated {
    background: #dafbe1;
    color: #1a7f37;
  }
  
  .incubating {
    background: #fff8c5;
    color: #9a6700;
  }
  
  .sandbox {
    background: #ddf4ff;
    color: #0969da;
  }
  
  .project-description {
    color: var(--color-text-secondary, #57606a);
    margin: 0.5rem 0;
    font-size: 0.875rem;
    line-height: 1.5;
  }
  
  .release-title {
    font-size: 1.25rem;
    margin: 0.5rem 0;
    line-height: 1.4;
  }
  
  .release-title a {
    color: var(--color-text-primary, #24292f);
    text-decoration: none;
    font-weight: 600;
  }
  
  .release-title a:hover {
    color: var(--color-text-link, #0969da);
    text-decoration: underline;
  }
  
  .release-date {
    color: var(--color-text-tertiary, #6e7781);
    font-size: 0.875rem;
    margin-bottom: 1rem;
  }
  
  .release-content {
    margin-top: 1rem;
    line-height: 1.6;
  }
  
  /* GitHub markdown styling */
  .markdown-body {
    color: var(--color-text-primary, #24292f);
    font-size: 1rem;
  }
  
  .markdown-body :global(h1),
  .markdown-body :global(h2),
  .markdown-body :global(h3),
  .markdown-body :global(h4) {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    font-weight: 600;
    line-height: 1.25;
  }
  
  .markdown-body :global(h1) { font-size: 1.75rem; border-bottom: 1px solid #d0d7de; padding-bottom: 0.3rem; }
  .markdown-body :global(h2) { font-size: 1.5rem; border-bottom: 1px solid #d0d7de; padding-bottom: 0.3rem; }
  .markdown-body :global(h3) { font-size: 1.25rem; }
  .markdown-body :global(h4) { font-size: 1rem; }
  
  .markdown-body :global(p) {
    margin-top: 0;
    margin-bottom: 1rem;
  }
  
  .markdown-body :global(ul),
  .markdown-body :global(ol) {
    padding-left: 2rem;
    margin-bottom: 1rem;
  }
  
  .markdown-body :global(li) {
    margin-bottom: 0.25rem;
  }
  
  .markdown-body :global(code) {
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    background-color: rgba(175, 184, 193, 0.2);
    border-radius: 6px;
    font-family: ui-monospace, 'Cascadia Code', 'Source Code Pro', Menlo, Consolas, monospace;
  }
  
  .markdown-body :global(pre) {
    padding: 1rem;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f6f8fa;
    border-radius: 6px;
    margin-bottom: 1rem;
  }
  
  .markdown-body :global(pre code) {
    padding: 0;
    background-color: transparent;
    border-radius: 0;
  }
  
  .markdown-body :global(blockquote) {
    padding: 0 1rem;
    border-left: 0.25rem solid #d0d7de;
    color: #57606a;
    margin: 0 0 1rem 0;
  }
  
  .markdown-body :global(table) {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 1rem;
  }
  
  .markdown-body :global(table th),
  .markdown-body :global(table td) {
    padding: 0.5rem 1rem;
    border: 1px solid #d0d7de;
  }
  
  .markdown-body :global(table th) {
    font-weight: 600;
    background-color: #f6f8fa;
  }
  
  .markdown-body :global(a) {
    color: #0969da;
    text-decoration: none;
  }
  
  .markdown-body :global(a:hover) {
    text-decoration: underline;
  }
  
  .markdown-body :global(img) {
    max-width: 100%;
    height: auto;
  }
  
  .markdown-body :global(hr) {
    height: 0.25rem;
    padding: 0;
    margin: 1.5rem 0;
    background-color: #d0d7de;
    border: 0;
  }
</style>
```

Key implementation details:
- Uses `set:html` for safe HTML insertion (Astro sanitizes)
- GitHub Primer-inspired styling (matches GitHub's actual markdown rendering)
- Scoped styles with `:global()` for markdown elements
- CSS custom properties for theming (future dark mode support)
- Responsive typography
  </action>
  <verify>
```bash
# Check component exists and has key elements
grep -q "renderMarkdown" src/components/ReleaseCard.astro && echo "âœ… Uses markdown rendering"
grep -q "set:html" src/components/ReleaseCard.astro && echo "âœ… Renders HTML safely"
grep -q "markdown-body" src/components/ReleaseCard.astro && echo "âœ… Has markdown styling"

# TypeScript check
npx tsc --noEmit
```
  </verify>
  <done>
- src/components/ReleaseCard.astro exists and renders release with markdown
- Imports and uses renderMarkdown() from markdown.ts
- Uses set:html to render markdown HTML
- Includes GitHub-style markdown CSS
- TypeScript compiles successfully
  </done>
</task>

<task type="auto">
  <name>Update index.astro to use ReleaseCard component</name>
  <files>src/pages/index.astro</files>
  <action>
Refactor `src/pages/index.astro` to use the new ReleaseCard component:

Replace the entire file content with:

```astro
---
import { getCollection } from 'astro:content';
import ReleaseCard from '../components/ReleaseCard.astro';

// Fetch all releases from the content collection
const releases = await getCollection('releases');

// Filter out error entries (feedStatus === 'error')
const validReleases = releases.filter(r => r.data.feedStatus !== 'error');

// Count errors for error banner (will be used in Plan 03)
const errorCount = releases.filter(r => r.data.feedStatus === 'error').length;

// Sort by date (newest first)
const sortedReleases = validReleases.sort((a, b) => {
  const dateA = a.data.isoDate ? new Date(a.data.isoDate).getTime() : 0;
  const dateB = b.data.isoDate ? new Date(b.data.isoDate).getTime() : 0;
  return dateB - dateA;
});

// Count by project status
const graduatedCount = validReleases.filter(r => r.data.projectStatus === 'graduated').length;
const incubatingCount = validReleases.filter(r => r.data.projectStatus === 'incubating').length;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="CNCF project releases aggregated in one place">
  <title>The Firehose - CNCF Releases</title>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="site-title">ðŸ”¥ The Firehose</h1>
      <p class="site-subtitle">CNCF Project Releases</p>
    </div>
  </header>
  
  <main class="container">
    <!-- Stats bar -->
    <div class="stats">
      <div class="stat">
        <div class="stat-value">{sortedReleases.length}</div>
        <div class="stat-label">Total Releases</div>
      </div>
      <div class="stat">
        <div class="stat-value">{graduatedCount}</div>
        <div class="stat-label">Graduated Projects</div>
      </div>
      <div class="stat">
        <div class="stat-value">{incubatingCount}</div>
        <div class="stat-label">Incubating Projects</div>
      </div>
      {errorCount > 0 && (
        <div class="stat stat-error">
          <div class="stat-value">{errorCount}</div>
          <div class="stat-label">Failed Feeds</div>
        </div>
      )}
    </div>
    
    <!-- Release list -->
    <div class="releases">
      {sortedReleases.map((release) => (
        <ReleaseCard release={release} />
      ))}
    </div>
  </main>
  
  <footer class="site-footer">
    <div class="container">
      <p>Aggregating {sortedReleases.length} releases from {new Set(sortedReleases.map(r => r.data.projectName)).size} CNCF projects</p>
      <p>Updated daily â€¢ <a href="https://github.com/castrojo/firehose" target="_blank" rel="noopener noreferrer">View on GitHub</a></p>
    </div>
  </footer>
</body>
</html>

<style>
  :root {
    /* Colors - GitHub Primer inspired */
    --color-bg-default: #ffffff;
    --color-bg-secondary: #f6f8fa;
    --color-border-default: #d0d7de;
    --color-text-primary: #24292f;
    --color-text-secondary: #57606a;
    --color-text-tertiary: #6e7781;
    --color-text-link: #0969da;
    --color-accent-emphasis: #0969da;
  }
  
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
    line-height: 1.6;
    color: var(--color-text-primary);
    background: var(--color-bg-secondary);
  }
  
  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 1rem;
  }
  
  .site-header {
    background: var(--color-bg-default);
    border-bottom: 1px solid var(--color-border-default);
    padding: 2rem 0;
    margin-bottom: 2rem;
  }
  
  .site-title {
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  
  .site-subtitle {
    color: var(--color-text-secondary);
    font-size: 1rem;
  }
  
  .stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
    background: var(--color-bg-default);
    border: 1px solid var(--color-border-default);
    border-radius: 6px;
    padding: 1.5rem;
  }
  
  .stat {
    text-align: center;
  }
  
  .stat-value {
    font-size: 2rem;
    font-weight: 600;
    color: var(--color-accent-emphasis);
  }
  
  .stat-error .stat-value {
    color: #cf222e;
  }
  
  .stat-label {
    color: var(--color-text-secondary);
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }
  
  .releases {
    margin-bottom: 3rem;
  }
  
  .site-footer {
    background: var(--color-bg-default);
    border-top: 1px solid var(--color-border-default);
    padding: 2rem 0;
    margin-top: 3rem;
    text-align: center;
    color: var(--color-text-secondary);
    font-size: 0.875rem;
  }
  
  .site-footer p {
    margin-bottom: 0.5rem;
  }
  
  .site-footer a {
    color: var(--color-text-link);
    text-decoration: none;
  }
  
  .site-footer a:hover {
    text-decoration: underline;
  }
  
  /* Responsive design */
  @media (max-width: 768px) {
    .site-title {
      font-size: 1.5rem;
    }
    
    .stats {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .stat-value {
      font-size: 1.5rem;
    }
  }
  
  @media (max-width: 480px) {
    .container {
      padding: 0 0.75rem;
    }
    
    .site-header {
      padding: 1.5rem 0;
    }
    
    .stats {
      grid-template-columns: 1fr;
      gap: 0.75rem;
      padding: 1rem;
    }
  }
</style>
```

Key changes:
- Import and use ReleaseCard component
- Filter out error entries from display
- Keep stats bar (count errors for visibility)
- Add proper semantic HTML structure (header, main, footer)
- Extract common styles to page level
- Add responsive design breakpoints
- Add meta tags for SEO
  </action>
  <verify>
```bash
# Build and check for errors
npm run build

# Verify component usage
grep -q "import ReleaseCard" src/pages/index.astro && echo "âœ… ReleaseCard imported"
grep -q "<ReleaseCard" src/pages/index.astro && echo "âœ… ReleaseCard used"

# Check for markdown in build output
ls dist/index.html && echo "âœ… Site built successfully"
```
  </verify>
  <done>
- index.astro imports and uses ReleaseCard component
- Error entries filtered out from display
- Stats bar shows total, graduated, incubating counts
- Site builds successfully
- All releases display with rendered markdown
  </done>
</task>

</tasks>

<verification>
**Build verification:**
```bash
npm run build
```
Expected: Build succeeds, no TypeScript errors

**Visual verification (manual in browser):**
1. Open `dist/index.html` in browser (via `npm run preview`)
2. Check release notes display with formatted markdown:
   - Headers have proper hierarchy and borders
   - Code blocks have background and monospace font
   - Lists are indented and bulleted
   - Links are blue and clickable
   - Tables render with borders (if present in releases)
3. Check that inline code has background color
4. Verify images render (if present in releases)

**Content verification:**
```bash
# Check that markdown HTML is present in build output
grep -q "<h2>" dist/index.html && echo "âœ… Headers rendered"
grep -q "<code>" dist/index.html && echo "âœ… Code blocks rendered"
grep -q "<ul>" dist/index.html && echo "âœ… Lists rendered"
```

**Requirement coverage:**
- DISP-02: Release notes render with proper markdown âœ…
- DISP-07: Clickable release titles âœ…
- Component structure established for Plans 02-04 âœ…
</verification>

<success_criteria>
1. âœ… User can see release notes with proper markdown formatting (not plain text)
2. âœ… Code blocks have gray background and monospace font
3. âœ… Headers have proper hierarchy (h1 > h2 > h3) with bottom borders
4. âœ… Lists are indented and properly formatted
5. âœ… Links are styled and clickable
6. âœ… Build completes successfully with no TypeScript errors
7. âœ… ReleaseCard component is reusable and well-structured
</success_criteria>

<output>
After completion, create `.planning/phases/03-user-interface/03-01-SUMMARY.md` with:
- marked library version installed
- renderMarkdown() function API
- ReleaseCard component structure
- Example of rendered markdown output
- Any markdown rendering edge cases discovered
</output>
