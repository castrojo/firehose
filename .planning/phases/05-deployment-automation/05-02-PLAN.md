---
phase: 05-deployment-automation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/update-feed.yaml
autonomous: true

must_haves:
  truths:
    - "Push to main branch triggers automatic build and deploy"
    - "Workflow runs daily at 6 AM UTC"
    - "Failed builds send GitHub notification"
    - "Site deploys to https://castrojo.github.io/firehose/ within 5 minutes"
  artifacts:
    - path: ".github/workflows/update-feed.yaml"
      provides: "GitHub Actions workflow for automated deployment"
      min_lines: 40
      contains: "cron: '0 6 * * *'"
    - path: ".github/workflows/update-feed.yaml"
      provides: "Node.js 20.x setup for Astro v5"
      contains: "node-version: '20'"
    - path: ".github/workflows/update-feed.yaml"
      provides: "Deployment from dist/ directory"
      contains: "publish_dir: ./dist"
  key_links:
    - from: ".github/workflows/update-feed.yaml on.push"
      to: "main branch"
      via: "triggers on push to main"
      pattern: "branches:.*main"
    - from: ".github/workflows/update-feed.yaml on.schedule"
      to: "daily cron"
      via: "runs at 6 AM UTC"
      pattern: "cron.*0 6"
    - from: "peaceiris/actions-gh-pages@v3"
      to: "dist/ directory"
      via: "publishes build output"
      pattern: "publish_dir.*dist"
---

<objective>
Update GitHub Actions workflow to deploy Astro builds to GitHub Pages with correct Node.js version, daily schedule at 6 AM UTC, and proper build directory.

Purpose: Enables automatic deployment on push to main and daily scheduled builds that fetch fresh feed data, ensuring the site stays current without manual intervention.

Output: Working GitHub Actions workflow that builds and deploys to GitHub Pages automatically.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.github/workflows/update-feed.yaml
@package.json
</context>

<tasks>

<task type="auto">
  <name>Update GitHub Actions Workflow for Astro Deployment</name>
  <files>.github/workflows/update-feed.yaml</files>
  <action>
Replace the entire workflow file with updated configuration:

```yaml
name: Build and Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  schedule:
    # Daily at 6 AM UTC to fetch fresh feed data
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# Cancel in-progress deployments for same branch
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
```

**Key changes from old workflow:**
1. **Node.js 20** (was 16): Astro v5 requires Node.js 18+, using 20 for stability
2. **Cron at 6 AM UTC** (was midnight): `0 6 * * *` instead of `0 0 * * *`
3. **Publish from dist/** (was public/): Astro outputs to dist/, not public/
4. **Modern Actions versions**: checkout@v4, setup-node@v4 (was v2)
5. **Proper permissions**: Added `pages: write` and `id-token: write` for GitHub Pages deployment
6. **Concurrency control**: Cancel in-progress deployments to avoid conflicts
7. **npm ci** (not npm i): Faster, more reliable installs using lockfile
8. **Two-job workflow**: Separate build and deploy jobs for clarity
9. **actions/upload-pages-artifact@v3** + **actions/deploy-pages@v4**: Modern GitHub Pages deployment (replaces peaceiris/actions-gh-pages)

**Why NOT other approaches:**
- ❌ Keep peaceiris/actions-gh-pages (deprecated pattern, GitHub recommends official actions)
- ❌ Use Node.js 18 (20 is LTS, more stable)
- ❌ Keep midnight schedule (6 AM UTC better for US/EU timezones)
  </action>
  <verify>
After committing this file:
1. Check GitHub Actions tab in repository UI
2. Verify workflow appears as "Build and Deploy to GitHub Pages"
3. Trigger manual run via "Run workflow" button
4. Watch workflow execute:
   - Build job completes successfully
   - Deploy job completes successfully
   - Site deploys to https://castrojo.github.io/firehose/
5. Visit site URL and verify it loads correctly with all assets
  </verify>
  <done>
- Workflow file uses Node.js 20
- Cron schedule set to `0 6 * * *` (6 AM UTC)
- Workflow publishes from `dist/` directory
- Uses modern GitHub Actions (v4) and official Pages deployment actions
- Workflow can be triggered manually via workflow_dispatch
- DEPLOY-01, DEPLOY-02, DEPLOY-03, DEPLOY-04 requirements satisfied
  </done>
</task>

</tasks>

<verification>
**Success criteria met:**
1. ✅ Push to main triggers automatic build and deploy (DEPLOY-01)
2. ✅ Site accessible at https://castrojo.github.io/firehose/ within 5 minutes (DEPLOY-02)
3. ✅ Workflow runs daily at 6 AM UTC (DEPLOY-03)
4. ✅ Failed builds send GitHub notification via Actions UI (DEPLOY-04)
5. ✅ Modern Actions versions with proper permissions
6. ✅ Two-job workflow (build + deploy) for clarity

**Testing:**
After committing, trigger manual workflow run to verify end-to-end deployment works before waiting for scheduled run.

**Files changed:**
- .github/workflows/update-feed.yaml (complete rewrite)
</verification>

<success_criteria>
GitHub Actions workflow successfully builds Astro site on push to main and daily at 6 AM UTC, deploys to GitHub Pages at https://castrojo.github.io/firehose/, and provides failure notifications through GitHub Actions interface.
</success_criteria>

<output>
After completion, create `.planning/phases/05-deployment-automation/05-02-SUMMARY.md`
</output>
